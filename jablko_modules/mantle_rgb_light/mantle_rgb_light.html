<script>
	const mantle_rgb_light = {
		status: async function() {
			await fetch("/jablko_modules/mantle_rgb_light/status", {method: "POST"})
				.then(async function(data) {
					const response = await data.json();
					if (response.status == "good") {
						document.getElementById("r").value = response.r;
						document.getElementById("g").value = response.g;
						document.getElementById("b").value = response.b;
						document.getElementById("a").value = response.a;
						const rgb_status = document.getElementById("mantle_rgb_light_status");
						rgb_status.style.backgroundColor = "var(--color-green)";
						rgb_status.textContent = "Online";
					} else {
						throw new Error("Unable to set RGBA");
					}
				})
				.catch(function(error) {
					console.log(error);
					const rgb_status = document.getElementById("mantle_rgb_light_status");
					rgb_status.style.backgroundColor = "var(--color-red)";
					rgb_status.textContent = "Offline";
				});
		},
		set_rgba: async function() {
			if (Date.now() < mantle_rgb_light.last_update) {
				return;
			}

			setTimeout(async function() {
				mantle_rgb_light.last_update = Date.now();
				const r = document.getElementById("r").value;
				const g = document.getElementById("g").value;
				const b = document.getElementById("b").value;
				const a = document.getElementById("a").value;
				const raw_response = await fetch("/jablko_modules/mantle_rgb_light/set_rgba", {
					method: "POST",
					headers: {
						"Accept": "application/json",
						"Content-Type": "application/json"
					},
					body: JSON.stringify({r, g, b, a})
				})
					.then(async function(data) {
						const json_response = await data.json();
						if (json_response.status == "good") {
							const rgb_status = document.getElementById("mantle_rgb_light_status");
							rgb_status.style.backgroundColor = "var(--color-green)";
							rgb_status.textContent = "Online";
						} else {
							throw new Error("Unable to set RGBA");
						}
					})
					.catch(error => {
						console.log(error);
						const rgb_status = document.getElementById("mantle_rgb_light_status");
						rgb_status.style.backgroundColor = "var(--color-red)";
						rgb_status.textContent = "Offline";
						return;
					});


			}, 100);

			mantle_rgb_light.last_update = Date.now() + 100;
		},
		last_update: Date.now()
	}

	document.addEventListener("DOMContentLoaded", function(event) {
		const r_slider = document.getElementById("r");
		const g_slider = document.getElementById("g");
		const b_slider = document.getElementById("b");
		const a_slider = document.getElementById("a");
		r_slider.oninput = function() {
			mantle_rgb_light.set_rgba();
		};

		g_slider.oninput = function() {
			mantle_rgb_light.set_rgba();
		}

		b_slider.oninput = function() {
			mantle_rgb_light.set_rgba();
		}

		a_slider.oninput = function() {
			mantle_rgb_light.set_rgba();
		}

		mantle_rgb_light.status();

		document.getElementById("mantle_rgb_light").addEventListener("mouseenter", function(event) {
			mantle_rgb_light.status();
		});
	});

</script>
<style>
#mantle_rgb_light > div > div > input {
	-webkit-appearance: slider-vertical;
	width: 20%;
	height: 40vh;
}	

#mantle_rgb_light_rgba > div > div {
	display: flex;
	justify-content: center;
	width: 20%;
	margin: 2px;
}
</style>
<div id="mantle_rgb_light" class="module_card">
	<div class="module_header">
		<h1>Mantle RGB</h1>
		<div id="mantle_rgb_light_status" class="status_indicator">N/A</div>
	</div>

	<div id="mantle_rgb_light_rgba" style="">
		<div style="display: flex; justify-content: center;">
			<div>Red</div>
			<div>Blue</div>
			<div>Green</div>
			<div>Alpha</div>
		</div>
		<div style="display: flex; justify-content: center;">
			<input id="r" type="range" min="0" max="255"></input>
			<input id="g" type="range" min="0" max="255"></input>
			<input id="b" type="range" min="0" max="255"></input>
			<input id="a" type="range" min="0" max="1" step="0.01"></input>
		</div>
	</div>
	<button onclick="mantle_rgb_light.set_rgba()">SET</button>
</div>
